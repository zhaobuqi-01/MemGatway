# MemGate

本项目在[go_gateway](https://github.com/e421083458/go_gateway)的基础上进行的二次开发。

## 相比[go_gateway](https://github.com/e421083458/go_gateway)的优化

* 实现数据热加载

使用redis作为消息队列，网关的控制面发布消息，反向代理服务器订阅消息；反向代理服务器收到消息，更新数据。

* 使用sync.Map代替[go_gateway](https://github.com/e421083458/go_gateway) 中使用slice存储数据

`sync.Map`是并发安全的，在高并发下表现良好。在数据较多的情况下，通过key-value读取数据，比遍历`silce`更快。可以根据需要将`sync.Map`替换为更高效的内存kv数据库，如fastcache，只需要实现对应的接口即可。

* 优化目录结构，使得更符合开源规范
* 增加enity层用于存放实体类
* 使用MVC架构，简化controller层，将复杂的逻辑放到Logic层
* ~~使用泛型函数代替dao层中重复的代码~~ **使用泛型接口解耦**

~~缺点是耦合度增加，因为Go的多态不支持多态方法~~

使用泛型接口进行接耦，使用gorm后续无法快速更换orm接口，但可以快速更改dao的接口实现方法；考虑到gorm框架的强大，所有实现对orm的快速更换。

* 重构其中的业务代码，使用接口解耦。

* 使用Viper进行配置解析

viper开箱即用。但是没有使用接口解耦，后续替换配置解析函数，需要在`configs/config.go`实现其中的方法，耦合过高。没有使用配置热加载。

* 使用`go-redis` 代替`redigo`

`go-redis`自动管理连接池，API使用更方便

* 增加`pkg` 目录

将redis，mysql，log进行封装在pkg目录，减少对外部库的引用，使得代码可读性增加

* 使用zap代理log标准库

zap日志库在高并发下的表现更好。zap支持日志轮转。

**缺点：**日志库无法更换，zap日志记录嵌入到项目代码中。

* 使用`golang.org/x/crypto/bcrypt`代替md5加密

## TODO

* 配置热加载
* 增加缓存

缓存后端服务器的热点数据，在代理服务器直接返回热点数据，减少后端服务器的压力。

* 将数据全部存储在内存改为通过redis按需缓存

改为redis按需缓存以后，可以支持更多的API并且性能不会下降太快。

* ~~增加系统监控~~==已完成==

使用`prometheus`监控系统状态

*  增加日志分析
*  优化响应返回函数
*  合理规划错误码

现在的错误码使用iota进行自增。

## 注意

* 该项目在运行时会将`MySql` 中的所有租户和API数据加载到内存中，如果数据库过大会导致内存使用率上升，性能下降。***故本项目适用于API和租户较少的系统。*** 

由于将数据直接存储在内存中在API和租户较少时性能较好。

* ***请勿在生成环境部署，本项目未经过全面的测试，可能会有未知的BUG。如在使用过程中有BUG产生，请反馈。***
* HTTP，TCP经过测试可以正常进行反向代理；GRPC未测试反向代理功能，故**不清楚GRPC反向代理是否可以正常运行。**
* **协议转换未进行测试**



